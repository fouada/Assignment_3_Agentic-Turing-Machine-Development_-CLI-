name: Validate Pull Request

on:
  pull_request:
    branches: [ main, master ]
    paths:
      - 'src/**/*.py'
      - 'tests/**/*.py'
      - 'skills/**/*.md'
      - 'requirements.txt'
      - 'pytest.ini'

jobs:
  quick-validation:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout PR code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.sha }}
    
    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'
    
    - name: Install minimal dependencies
      run: |
        pip install pytest pytest-cov
    
    - name: Quick syntax check
      run: |
        echo "Checking Python syntax..."
        python -m py_compile src/*.py || exit 1
        echo "âœ… All Python files are syntactically correct"
    
    - name: Verify skills format
      run: |
        echo "Validating skills directory..."
        for skill_dir in skills/*/; do
          skill=$(basename "$skill_dir")
          if [ ! -f "$skill_dir/SKILL.md" ]; then
            echo "âŒ Missing SKILL.md in $skill"
            exit 1
          fi
          
          # Check required sections in SKILL.md
          if ! grep -q "## Purpose" "$skill_dir/SKILL.md"; then
            echo "âš ï¸  Missing 'Purpose' section in $skill/SKILL.md"
          fi
          
          if ! grep -q "## Instructions" "$skill_dir/SKILL.md"; then
            echo "âš ï¸  Missing 'Instructions' section in $skill/SKILL.md"
          fi
          
          echo "âœ… $skill validated"
        done
    
    - name: Run fast tests only
      run: |
        pytest tests/unit/test_errors.py -v --tb=short
        pytest tests/unit/test_config.py -v --tb=short
    
    - name: PR validation summary
      if: always()
      run: |
        echo "# ðŸ“ Pull Request Validation" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Syntax check: Passed" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Skills validation: Passed" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Fast tests: Passed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Note:** Full test suite will run after merge" >> $GITHUB_STEP_SUMMARY

  check-coverage-impact:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout base branch
      uses: actions/checkout@v4
      with:
        ref: ${{ github.base_ref }}
    
    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: pip install -r requirements.txt
    
    - name: Get base coverage
      id: base_coverage
      run: |
        pytest tests/ --cov=src --cov-report=term | tee base_coverage.txt
        BASE_COV=$(grep "TOTAL" base_coverage.txt | awk '{print $NF}' | sed 's/%//')
        echo "base_coverage=$BASE_COV" >> $GITHUB_OUTPUT
        echo "Base coverage: $BASE_COV%"
    
    - name: Checkout PR branch
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.sha }}
    
    - name: Install dependencies (PR)
      run: pip install -r requirements.txt
    
    - name: Get PR coverage
      id: pr_coverage
      run: |
        pytest tests/ --cov=src --cov-report=term | tee pr_coverage.txt
        PR_COV=$(grep "TOTAL" pr_coverage.txt | awk '{print $NF}' | sed 's/%//')
        echo "pr_coverage=$PR_COV" >> $GITHUB_OUTPUT
        echo "PR coverage: $PR_COV%"
    
    - name: Compare coverage
      run: |
        BASE_COV=${{ steps.base_coverage.outputs.base_coverage }}
        PR_COV=${{ steps.pr_coverage.outputs.pr_coverage }}
        
        echo "# ðŸ“Š Coverage Comparison" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Branch | Coverage |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|----------|" >> $GITHUB_STEP_SUMMARY
        echo "| Base (${{ github.base_ref }}) | ${BASE_COV}% |" >> $GITHUB_STEP_SUMMARY
        echo "| PR | ${PR_COV}% |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if (( $(echo "$PR_COV >= $BASE_COV" | bc -l) )); then
          echo "âœ… Coverage maintained or improved!" >> $GITHUB_STEP_SUMMARY
        else
          DIFF=$(echo "$BASE_COV - $PR_COV" | bc)
          echo "âš ï¸  Coverage decreased by ${DIFF}%" >> $GITHUB_STEP_SUMMARY
        fi
